<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>小翠医生</title>

        <!-- Favicon -->
        <link rel="icon" href="../../assets/css/Doctor_port_css/icons.css" type="image/png">
        <!--<link rel="stylesheet" type="text/css" href="../../assets/css/bootstrap.min.css"/>-->
        <!-- Bundle Styles -->
        <link rel="stylesheet" href="../../assets/css/chat/vendor/bundle.css">
        <link rel="stylesheet" href="../../assets/css/chat/vendor/enjoyhint/enjoyhint.css">
        <!-- App styles -->
        <link rel="stylesheet" href="../../assets/css/chat/dist/css/app.min.css">
        <link rel="stylesheet" type="text/css" href="../../assets/css/chat/online_ask.css"/>
    </head>
<body>

<!-- page loading -->
<div class="page-loading"></div>
<!-- ./ page loading -->

<div id="app">
    <!-- voice call modal -->
    <div class="modal call fade" id="call" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-zoom" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="call">
                        <div>
                            <figure class="mb-4 avatar avatar-xl">
                                <img src="../../assets/images/heads.jpg" class="rounded-circle" alt="image">
                            </figure>
                            <h4>Brietta Blogg <span class="text-success">calling...</span></h4>
                            <div class="action-button">
                                <button type="button" class="btn btn-danger btn-floating btn-lg" data-dismiss="modal">
                                    <i data-feather="x"></i>
                                </button>
                                <button type="button" class="btn btn-success btn-pulse btn-floating btn-lg">
                                    <i data-feather="phone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ./ voice call modal -->

    <!-- layout -->
    <div class="layout">

        <!-- navigation -->
        <nav class="navigation">
            <div class="nav-group">
                <ul>
                    <li class="logo">
                        <a href="#">
                            <svg version="1.1" xmlns="http://www.w3.org/2000/svg"
                                 xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                 width="612px" height="612px" viewBox="0 0 612 612"
                                 style="enable-background:new 0 0 612 612;" xml:space="preserve">
                            <g>
                                <g id="_x32__26_">
                                    <g>
                                    <path d="M401.625,325.125h-191.25c-10.557,0-19.125,8.568-19.125,19.125s8.568,19.125,19.125,19.125h191.25
                                    c10.557,0,19.125-8.568,19.125-19.125S412.182,325.125,401.625,325.125z M439.875,210.375h-267.75
                                    c-10.557,0-19.125,8.568-19.125,19.125s8.568,19.125,19.125,19.125h267.75c10.557,0,19.125-8.568,19.125-19.125
                                    S450.432,210.375,439.875,210.375z M306,0C137.012,0,0,119.875,0,267.75c0,84.514,44.848,159.751,114.75,208.826V612
                                    l134.047-81.339c18.552,3.061,37.638,4.839,57.203,4.839c169.008,0,306-119.875,306-267.75C612,119.875,475.008,0,306,0z
                                    M306,497.25c-22.338,0-43.911-2.601-64.643-7.019l-90.041,54.123l1.205-88.701C83.5,414.133,38.25,345.513,38.25,267.75
                                    c0-126.741,119.875-229.5,267.75-229.5c147.875,0,267.75,102.759,267.75,229.5S453.875,497.25,306,497.25z"/>
                                    </g>
                                </g>
                            </g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                                <g></g>
                        </svg>
                        </a>
                    </li>
                    <li>
                        <a class="active" data-navigation-target="chats" href="#" data-toggle="tooltip" title="Chats"
                           data-placement="right">
                            <span class="badge badge-warning"></span>
                            <i data-feather="message-circle"></i>
                        </a>
                    </li>
                    <!--<li>
                        <a data-navigation-target="friends" href="#" data-toggle="tooltip"
                           title="Friends" data-placement="right">
                            <span class="badge badge-danger"></span>
                            <i data-feather="user"></i>
                        </a>
                    </li>
                    <li>
                        <a data-navigation-target="favorites" data-toggle="tooltip" title="Favorites" data-placement="right"
                           href="#">
                            <i data-feather="star"></i>
                        </a>
                    </li>
                    <li class="brackets">
                        <a data-navigation-target="archived" href="#" data-toggle="tooltip"
                           title="Archived" data-placement="right">
                            <i data-feather="archive"></i>
                        </a>
                    </li>-->
                    <li>
                        <a href="#" class="dark-light-switcher" data-toggle="tooltip" title="Dark mode"
                           data-placement="right">
                            <i data-feather="moon"></i>
                        </a>
                    </li>
                    <li data-toggle="tooltip" title="User menu" data-placement="right">
                        <a href="./login.html" data-toggle="dropdown">
                            <figure class="avatar">
                                <img :src="doctor.doctorImg" class="rounded-circle" alt="image">
                            </figure>
                        </a>
                        <div class="dropdown-menu">

                            <a href="#" class="dropdown-item" data-navigation-target="my-information">我的信息</a>
                            <!--<a href="#" class="dropdown-item" data-toggle="modal" data-target="#settingModal">Settings</a>-->
                            <div class="dropdown-divider"></div>
                            <a onclick="exitConsult()" href="javascript:void (0)"
                               class="dropdown-item text-danger">退出聊天</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- ./ navigation -->

        <!-- content -->
        <div class="content">


            <!-- chat -->
            <div class="chat">

                <div class="chat-header">
                    <div class="chat-header-user">
                        <figure class="">
                            <img :src="maternal.maternal_img" class="rounded-circle" alt="image">
                        </figure>
                        <div>
                            <h5>菜玉溪
                                <small class="user_status">
                                    <span v-if="maternal.maternal_status == 1" style="color: #6C6C6C;">在孕中</span>
                                    <span v-if="maternal.maternal_status == 2" style="color: #6C6C6C;">已产</span>
                                    <span v-if="maternal.maternal_status == 3" style="color: #6C6C6C;">备孕</span>
                                    <span v-if="maternal.maternal_status == 4" style="color: #6C6C6C;">未知</span>
                                </small>
                            </h5>

                            <p>{{maternal.maternal_city}}</p>
                        </div>
                    </div>
                    <div class="chat-header-action">
                        <ul class="list-inline">
                            <li class="list-inline-item d-xl-none d-inline">
                                <a href="#" class="btn btn-outline-light mobile-navigation-button">
                                    <i data-feather="menu"></i>
                                </a>
                            </li>
                            <li class="list-inline-item" data-toggle="tooltip" title="Voice call">
                                <a href="#" class="btn btn-outline-light text-success" data-toggle="modal"
                                   data-target="#call">
                                    <i data-feather="phone"></i>
                                </a>
                            </li>
                            <li class="list-inline-item" data-toggle="tooltip" title="Video call">
                                <a href="#" class="btn btn-outline-light text-warning" data-toggle="modal"
                                   data-target="#videoCall">
                                    <i data-feather="video"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-outline-light" data-toggle="dropdown">
                                    <i data-feather="more-horizontal"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" data-navigation-target="contact-information"
                                       class="dropdown-item">个人信息</a>
                                    <!--<a href="#" class="dropdown-item">关注</a>-->
                                    <!-- <div class="dropdown-divider"></div>
                                     <a href="#" class="dropdown-item text-danger">投诉</a>-->
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="chat-body"> <!-- .no-message -->

                    <div class="messages">

                        <!--
                                                <div class="message-item outgoing-message">
                                                    <div class="message-avatar">
                                                        <figure class="avatar">
                                                            <img src="../../assets/images/heads.jpg" class="rounded-circle" alt="image">
                                                        </figure>
                                                        <div>
                                                            <h5>李翠翠</h5>
                                                            <div class="time">01:20 PM <i class="ti-double-check text-info"></i></div>
                                                        </div>
                                                    </div>
                                                    <div class="message-content">
                                                        Hello how are you?
                                                    </div>
                                                </div>

                                                <div class="message-item">
                                                    <div class="message-avatar">
                                                        <figure class="avatar">
                                                            <img src="../../assets/images/baby.jpg" class="rounded-circle" alt="image">
                                                        </figure>
                                                        <div>
                                                            <h5>菜熙熙</h5>
                                                            <div class="time">01:35 PM</div>
                                                        </div>
                                                    </div>
                                                    <div class="message-content">
                                                        I'm fine, how are you 😃
                                                    </div>
                                                </div>
                                                &lt;!&ndash;file&ndash;&gt;
                                                <div class="message-item">
                                                    <div class="message-avatar">
                                                        <figure class="avatar">
                                                            <img src="../../assets/images/baby.jpg" class="rounded-circle" alt="image">
                                                        </figure>
                                                        <div>
                                                            <h5>菜熙熙</h5>
                                                            <div class="time">11:59 PM</div>
                                                        </div>
                                                    </div>
                                                    <div class="message-content message-file">
                                                        <div class="file-icon">
                                                            <i class="fa fa-file-pdf-o"></i>
                                                        </div>
                                                        <div>
                                                            <div>important_documents.pdf <i class="text-muted small">(50KB)</i></div>
                                                            <ul class="list-inline">
                                                                <li class="list-inline-item mb-0"><a href="#">Download</a></li>
                                                                <li class="list-inline-item mb-0"><a href="#">View</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>

                                                &lt;!&ndash;今天&ndash;&gt;
                                                &lt;!&ndash;<div class="message-item messages-divider sticky-top" data-label="Today"></div>&ndash;&gt;

                                                &lt;!&ndash;图片&ndash;&gt;
                                                <div class="message-item">
                                                    <div class="message-avatar">
                                                        <figure class="avatar">
                                                            <img src="../../assets/images/baby.jpg" class="rounded-circle" alt="image">
                                                        </figure>
                                                        <div>
                                                            <h5>菜熙熙</h5>
                                                            <div class="time">10:43 AM</div>
                                                        </div>
                                                    </div>
                                                    <figure>
                                                        <img src="../../assets/images/admin.jpg" class="w-60 img-fluid rounded" alt="image">
                                                    </figure>
                                                </div>

                                                <div class="message-item outgoing-message">
                                                    <div class="message-avatar">
                                                        <figure class="avatar">
                                                            <img src="../../assets/images/heads.jpg" class="rounded-circle" alt="image">
                                                        </figure>
                                                        <div>
                                                            <h5>李翠翠</h5>
                                                            <div class="time">10:50 AM <i class="ti-double-check text-info"></i></div>
                                                        </div>
                                                    </div>
                                                    <div class="message-content">
                                                        You are good ❤❤
                                                    </div>
                                                </div>
                        -->

                        <!--未读-->
                        <!--<div class="message-item messages-divider" data-label="1 message unread"></div>-->

                    </div>
                </div>
                <!--聊天框底部-->
                <div class="chat-footer">
                    <form id="form_table" enctype="multipart/form-data" action="" onsubmit="return false">

                        <input id="inputbox" type="text" class="form-control" placeholder="Write a message.">

                        <div class="form-buttons">

                            <label class="file_icon btn btn-light filebtn" for="file">
                                <i data-feather="file"></i>
                                <input id="file" type="file" name="file" hidden=""/>
                            </label>

                            <button class="btn btn-primary" onclick="send()" type="submit">
                                <i data-feather="send"></i>
                            </button>

                        </div>
                    </form>
                </div>

            </div>
            <!-- ./ chat -->

            <div class="sidebar-group">
                <div id="contact-information" class="sidebar">
                    <header>
                        <span>用户信息</span>
                        <ul class="list-inline">
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-outline-light text-danger sidebar-close">
                                    <i data-feather="x"></i>
                                </a>
                            </li>
                        </ul>
                    </header>

                    <div class="sidebar-body">
                        <div class="pl-4 pr-4">
                            <div class="text-center">
                                <figure class="avatar avatar-xl mb-4">
                                    <img :src="maternal.maternal_img" class="rounded-circle" alt="image">
                                </figure>
                                <h5 class="mb-1">{{maternal.maternal_nickname}}</h5>
                                <small class="text-muted " v-if="maternal.maternal_status == 1">在孕中</small>
                                <small class="text-muted " v-if="maternal.maternal_status == 2">已产</small>
                                <small class="text-muted " v-if="maternal.maternal_status == 3">备孕</small>
                                <small class="text-muted " v-if="maternal.maternal_status == 0">未知</small>
                                <ul class="nav nav-tabs justify-content-center mt-5" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" data-toggle="tab" href="#home"
                                           role="tab"
                                           aria-controls="home" aria-selected="true">基本信息</a>
                                    </li>
                                    <!--<li class="nav-item">
                                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                                           aria-controls="profile" aria-selected="false">相关</a>
                                    </li>-->
                                </ul>

                            </div>

                            <div class="tab-content">

                                <div class="tab-pane fade show active" role="tabpanel"
                                     aria-labelledby="home-tab">
                                    <div class="mt-4 mb-4">
                                        <h6>Phone</h6>
                                        <p class="text-muted">{{maternal.maternal_tel}}</p>
                                    </div>
                                    <div class="mt-4 mb-4">
                                        <h6>怀孕周期</h6>
                                        <p class="text-muted">{{maternal.maternal_preg_week}}</p>
                                    </div>
                                    <div class="mt-4 mb-4">
                                        <h6>Email</h6>
                                        <p>
                                            <a href="#">{{maternal.maternal_email}}</a>
                                        </p>
                                    </div>


                                    <!--<div class="mt-4 mb-4">
                                        <h6 class="mb-3">Settings</h6>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="customSwitch11">
                                                <label class="custom-control-label" for="customSwitch11">Block</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" checked=""
                                                       id="customSwitch12">
                                                <label class="custom-control-label" for="customSwitch12">Mute</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="customSwitch13">
                                                <label class="custom-control-label" for="customSwitch13">Get
                                                    notification</label>
                                            </div>
                                        </div>
                                    </div>-->
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
                <div id="my-information" class="sidebar">
                    <header>
                        <span>我的信息</span>
                        <ul class="list-inline">
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-outline-light text-danger sidebar-close">
                                    <i data-feather="x"></i>
                                </a>
                            </li>
                        </ul>
                    </header>

                    <div class="sidebar-body">
                        <div class="pl-4 pr-4">
                            <div class="text-center">
                                <figure class="avatar avatar-xl mb-4">
                                    <img :src="doctor.doctorImg" class="rounded-circle" alt="image">
                                </figure>
                                <h5 class="mb-1">{{doctor.doctorName}}</h5>
                                <small class="text-muted ">在线</small>

                                <ul class="nav nav-tabs justify-content-center mt-5" id="myTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home"
                                           role="tab"
                                           aria-controls="home" aria-selected="true">基本信息</a>
                                    </li>
                                    <!--<li class="nav-item">
                                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                                           aria-controls="profile" aria-selected="false">相关</a>
                                    </li>-->
                                </ul>

                            </div>

                            <div class="tab-content" id="myTabContent">

                                <div class="tab-pane fade show active" id="home" role="tabpanel"
                                     aria-labelledby="home-tab">
                                    <p class="text-muted">
                                        {{doctor.doctorIntroduction}}
                                    </p>
                                    <div class="mt-4 mb-4">
                                        <h6>Phone</h6>
                                        <p class="text-muted">{{doctor.doctorTel}}</p>
                                    </div>
                                    <div class="mt-4 mb-4">
                                        <h6>City</h6>
                                        <p class="text-muted">{{doctor.doctorCity}}</p>
                                    </div>
                                    <div class="mt-4 mb-4">
                                        <h6>Email</h6>
                                        <p>
                                            <a href="#">{{doctor.doctorEmail}}</a>
                                        </p>
                                    </div>


                                    <!--<div class="mt-4 mb-4">
                                        <h6 class="mb-3">Settings</h6>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="customSwitch11">
                                                <label class="custom-control-label" for="customSwitch11">Block</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" checked=""
                                                       id="customSwitch12">
                                                <label class="custom-control-label" for="customSwitch12">Mute</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="form-item custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input" id="customSwitch13">
                                                <label class="custom-control-label" for="customSwitch13">Get
                                                    notification</label>
                                            </div>
                                        </div>
                                    </div>-->
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- ./ content -->

    </div>
    <!-- ./ layout -->
</div>
<!-- Bundle -->
<script src="https://www.jq22.com/jquery/jquery-3.3.1.js"></script>
<!--<script src="../../assets/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>-->
<script src="../../assets/css/chat/vendor/bundle.js"></script>
<script src="../../assets/css/chat/vendor/feather.min.js"></script>
<script src="../../assets/css/chat/vendor/enjoyhint/enjoyhint.min.js"></script>

<!-- App scripts -->
<script src="../../assets/css/chat/dist/js/app.min.js"></script>

<!-- Examples -->
<script src="../../assets/css/chat/dist/js/examples(new).js"></script>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="../../assets/js/GlobalVariables.js"></script>
<script src="../../assets/js/GlobalMethod.js"></script>
<script src="../../assets/js/jquery.params.js"></script>

<script>
    $("#file").bind("input propertychange", function (event) {
        var pro = $("#file").val();
    });
</script>

<script>
    let fromId = $.query.get("docId");
    let websocket;
    let to = $.query.get("matId")
    $(function () {

        $.ajax({
            url: "http://" + host + "/doctor/getDoctorByID",
            method: "get",
            data: {
                doctorID: fromId,
            },
            async: false,
            xhrFields: {
                withCredentials: true  //带上cookie信息，解决sessionid不一致
            },
            success: function (result) {
                console.log(result)
                app.doctor = result.data
            }
        });

        $.ajax({
            url: "http://" + host + "/maternal/getMaternalById",
            method: "get",
            async: false,
            data: {
                matID: to,
            },
            xhrFields: {
                withCredentials: true  //带上cookie信息，解决sessionid不一致
            },
            success: function (result) {
                console.log(result)

                app.maternal = result.data
            }
        });


        let url = "ws://" + host + "/webSocket/" + fromId + "/" + "doctor"
        websocket = new WebSocket(url);

        websocket.onopen = function () {
            console.log("WebSocket连接成功");
        }


        websocket.onmessage = function (event) {
            console.log("回调信息")
            let type = event.data.split(':')[1];
            console.log(type)
            let data

            if (type == 'image') {
                data = '<figure><img class="w-60 img-fluid rounded" alt="image" src=" ../../assets/images/chatImg/' + event.data.split(':')[2] + '"></figure>'
            } else {
                data = `<div class="message-content">` + event.data.split(':')[2] + `</div>`
            }
            insertMsg(data, '', app.maternal.maternal_name, app.maternal.maternal_img)

        }

        function closeWebSocket() {
            websocket.close();
        }


    })

    function send() {
        let message = document.getElementById('inputbox').value;
        //message作为发送的信息，role作为发送的对象标识，socketId是此次会话的标识
        if (message != null && message != '') {
            websocket.send(JSON.stringify({'message': message, 'type': 'text', 'to': to}));
        }
        let data = `<div class="message-content">` + message + `</div>`
        insertMsg(data, 'outgoing-message', app.doctor.doctorName, app.doctor.doctorImg)


        let pro = $("#file").val();
        if (pro != null && pro != '') {
            sendImage()
        }


    }

    function sendImage() {
        let fd = new FormData($("#form_table")[0]);
        $.ajax({
            type: "POST",
            url: "http://" + host + "/index/uploadImage",
            data: fd,
            processData: false,
            contentType: false,
            success: function (result) {
                let fileName = result.message
                websocket.send(JSON.stringify({'message': fileName, 'type': 'image', 'to': to}));
                let data = '<figure><img class="w-60 img-fluid rounded" alt="image" src=" ../../assets/images/chatImg/' + fileName + '"></figure>'
                insertMsg(data, 'outgoing-message', app.doctor.doctorName, app.doctor.doctorImg)
            }
        });
    }


    function insertMsg(data, type, name, imgPath) {
        var chat_body = $('.layout .content .chat .chat-body');
        $('.layout .content .chat .chat-body .messages').append(`<div class="message-item ` + type + ` " '>
                        <div class="message-avatar">
                            <figure class="avatar">
                                <img src=" ` + imgPath + `" class="rounded-circle">
                            </figure>
                            <div>
                                <h5>` + name + `</h5>
                                <div class="time">` + formatDate(new Date(), "hh:mm") + `</div>
                            </div>
                        </div>
                         ` + data + `

                    </div>`);
        setTimeout(function () {
            chat_body.scrollTop(chat_body.get(0).scrollHeight, -1).niceScroll({
                cursorcolor: 'rgba(66, 66, 66, 0.20)',
                cursorwidth: "4px",
                cursorborder: '0px'
            }).resize();
        }, 200);

    }


    function exitConsult() {
        $.ajax({
            type: "POST",
            url: "http://" + host + "/doctor/exitConsult",
            data: {
                doctorId: fromId,
            },
            success: function (result) {
                if (result.status == '200') {
                    window.location.href = "../index.html"
                } else {
                    alert(result.message)
                }

            }
        });
    }
</script>

<script>
    let app = new Vue({
        el: "#app",
        data: {
            doctor: {},
            maternal: {},
        }
    })
</script>
</body>
</html>